{namespace s=S3b0\ProjectRegistration\ViewHelpers}
<f:layout name="Default"/>

<f:section name="main">

	<f:render partial="FlashMessages" arguments="{_all}"/>

	<section class="data">
		<input type="search" class="light-table-filter form-control" data-table="table" placeholder="Filter">
		<p>&nbsp;</p>
		<table id="pradm-list" class="table table-striped table-hover">
			<thead>
			<tr>
				<th class="sortable num" data-sort="int">Project#</th>
				<th class="sortable amount" data-sort="date">Date of request</th>
				<th class="sortable alpha" data-sort="string-ins">Registrant</th>
				<th></th>
				<th class="sortable alpha" data-sort="string-ins">Company</th>
				<th class="sortable alpha" data-sort="string-ins">Region</th>
				<th class="sortable alpha" data-sort="string-ins">Project name</th>
				<th class="sortable alpha" data-sort="string-ins">Company (End-user)</th>
				<th class="sortable alpha" data-sort="string-ins">Country (End-user)</th>
				<th class="sortable alpha" data-sort="string-ins">Product</th>
				<th class="sortable num" data-sort="int">Quantity</th>
				<th class="sortable amount" data-sort="date">Estimated rollout</th>
				<th class="sortable amount" data-sort="int">State</th>
				<th></th>
			</tr>
			</thead>

			<tbody>
			<f:for each="{projects}" as="project">
				<tr>
					<td>{project.uid}</td>
					<td>{project.dateOfRequest -> f:format.date(format: 'd-m-Y')}</td>
					<td>{project.registrant.name}
						<f:if condition="{f:ecom.inArray(haystack: project.registrant.feUserGroups, needle: settings.certifiedUsersUserGroup)}">
							<f:then><span class="text-primary"><i class="fa fa-star fa-fw"></i></span></f:then>
							<f:else>
								<f:if condition="{project.registrant.feUser}"><i class="fa fa-star fa-fw"></i></f:if>
							</f:else>
						</f:if>
					</td>
					<td>
						<f:link.action action="show" controller="Person" arguments="{person: project.registrant}" title="Show registrant details"><i class="fa fa-user"></i></f:link.action>&nbsp;
						<a data-toggle="popover" title="E-M@il:" data-content="{project.registrant.email}"><i class="fa fa-envelope-o"></i></a>&nbsp;
						<a data-toggle="popover" title="Phone:" data-content="{project.registrant.phone}"><i class="fa fa-phone-square"></i></a>
						<f:if condition="{project.internalNote}">
							<a data-toggle="popover" title="Internal note:" data-content="{project.internalNote}"><span class="text-primary"><i class="fa fa-sticky-note"></i></span></a>
						</f:if>
						<f:if condition="{project.denialNote}">
							<a data-toggle="popover" title="Denial note:" data-content="{project.denialNote}"><span class="text-danger"><i class="fa fa-sticky-note"></i></span></a>
						</f:if>
					</td>
					<td>{project.registrant.company}</td>
					<td>{s:getArrayElement(array: addressees, key: project.addressee)}</td>
					<td>{project.title}</td>
					<td>{project.endUser.company}</td>
					<td>{project.endUser.country.title}</td>
					<td>{project.product.title}</td>
					<td>{project.quantity}</td>
					<td>{project.estimatedPurchaseDate -> f:format.date(format: 'd-m-Y')}</td>
					<f:if condition="{project.hidden}">
						<f:then><td data-sort-value="2"></f:then>
						<f:else>
							<f:if condition="{project.approved}">
								<f:then><td data-sort-value="0"></f:then>
								<f:else><td data-sort-value="1"></f:else>
							</f:if>
						</f:else>
					</f:if>
						<f:if condition="{project.hidden}">
							<f:then>
								<f:link.action action="accept" arguments="{project: project}" noCacheHash="1">
									<i class="fa fa-check-circle-o fa-lg"></i>
								</f:link.action>
								&nbsp;
								<f:link.action arguments="{project: project}" noCacheHash="1" onclick="askForNoteOnDenial(this,'Do you want to add a note?')">
									<i class="fa fa-times-circle-o fa-lg"></i>
								</f:link.action>
							</f:then>
							<f:else>
								{project.fontAwesomeStatus -> f:format.raw()}
							</f:else>
						</f:if>
					&nbsp;
					<f:link.action action="addInternalNote" arguments="{project: project}" title="Add internal note">
						<f:if condition="{project.internalNote}">
							<f:then><i class="fa fa-sticky-note"></i></f:then>
							<f:else><i class="fa fa-sticky-note-o"></i></f:else>
						</f:if>
					</f:link.action>
					</td>
					<td>
						<f:link.action action="show" arguments="{project: project}" target="_blank"><i class="fa fa-lg fa-fw fa-info-circle"></i></f:link.action>
					</td>
				</tr>
			</f:for>
			</tbody>
		</table>
	</section>

	<script language="JavaScript" type="text/javascript">
		function askForNoteOnDenial(e,m) {
			if ( confirm(m)) {
				e.href += "&tx_projectregistration_administration%5Baction%5D=addDenialNote";
			} else {
				e.href += "&tx_projectregistration_administration%5Baction%5D=reject";
			}
		}

		/**
		 * Credits to Chris Coyier @see http://codepen.io/chriscoyier/pen/tIuBL
		 */
		(function(document) {
			'use strict';

			var LightTableFilter = (function(Arr) {

				var _input;

				function _onInputEvent(e) {
					_input     = e.target;
					var tables = document.getElementsByClassName(_input.getAttribute('data-table'));
					Arr.forEach.call(tables, function(table) {
						Arr.forEach.call(table.tBodies, function(tbody) {
							Arr.forEach.call(tbody.rows, _filter);
						});
					});
				}

				function _filter(row) {
					var text          = row.textContent.toLowerCase(), val = _input.value.toLowerCase();
					row.style.display = text.indexOf(val) === -1 ? 'none' : 'table-row';
				}

				return {
					init: function() {
						var inputs = document.getElementsByClassName('light-table-filter');
						Arr.forEach.call(inputs, function(input) {
							input.oninput = _onInputEvent;
						});
					}
				};
			})(Array.prototype);

			document.addEventListener('readystatechange', function() {
				if (document.readyState === 'complete') {
					LightTableFilter.init();
				}
			});

		})(document);

		/**
		 * Credits to Joseph McCullough @see http://joequery.github.io/Stupid-Table-Plugin/
		 */
		$(function() {
			// Helper function to convert a string of the form "15-03-1987" into
			// a Date object.
			var date_from_string = function(str) {
				var pattern   = "^(\\d{2})-(\\d{2})-(\\d{4})$";
				var re        = new RegExp(pattern);
				var DateParts = re.exec(str)
				                  .slice(1);
				var Year      = DateParts[2];
				var Month     = DateParts[1];
				var Day       = DateParts[0];
				return new Date(Year, Month, Day);
			};
			$("#pradm-list").stupidtable({
				"date": function(a, b) {
					// Get these into date objects for comparison.
					aDate = date_from_string(a);
					bDate = date_from_string(b);
					return aDate - bDate;
				}
			});
		});
	</script>
</f:section>